<div id="ui">
    <div>Время: <span id="time">0</span>с</div>
    <div>Рекорд: <span id="best">0</span>с</div>
    <div>Топливо: <span id="fuel">100</span>%</div>
</div>

<div id="startScreen">
    <h1 class="glow">КОСМИЧЕСКИЙ ПОБЕГ</h1>
    <p>Мышь или палец — корабль следует за тобой</p>
    <p>Собирай топливо • Уворачивайся от астероидов</p>
    <button onclick="startGame()">СТАРТ</button>
</div>

<div id="gameOverScreen" style="display:none">
    <h1 class="glow">ВЗРЫВ</h1>
    <p>Ты продержался <span id="finalTime">0</span> секунд</p>
    <p id="newRecord" style="color:#0f0; font-size:2.2rem; display:none">НОВЫЙ РЕКОРД!</p>
    <button onclick="startGame()">ЕЩЁ РАЗ</button>
</div>

<script>
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    let w = canvas.width  = window.innerWidth;
    let h = canvas.height = window.innerHeight;

    // Безопасный ресайз
    let resizeTimer;
    function resize() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            w = canvas.width  = window.innerWidth;
            h = canvas.height = window.innerHeight;
            if (gameRunning) ringRadius = Math.max(w, h) * 1.4;
        }, 100);
    }
    window.addEventListener('resize', resize);
    window.addEventListener('orientationchange', resize);

    let player = { x: w/2, y: h/2, r: 15, trail: [] };
    let asteroids = [], fuels = [], particles = [];
    let time = 0, best = parseInt(localStorage.getItem('spaceEscapeBest')||'0'), fuel = 100;
    let ringRadius = Math.max(w, h) * 1.4;
    let gameRunning = false;
    let lastShrink = 0;

    document.getElementById('best').textContent = best;

    // Управление
    const movePlayer = e => {
        if (!gameRunning) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        player.x = touch.clientX - rect.left;
        player.y = touch.clientY - rect.top;
    };
    canvas.addEventListener('mousemove', movePlayer);
    canvas.addEventListener('touchmove', movePlayer, {passive:false});
    canvas.addEventListener('touchstart', e => e.preventDefault());

    function startGame() {
        gameRunning = true;
        time = 0; fuel = 100;
        asteroids = []; fuels = []; particles = [];
        player = { x: w/2, y: h/2, r: 15, trail: [] };
        ringRadius = Math.max(w, h) * 1.4;
        lastShrink = 0;
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('gameOverScreen').style.display = 'none';
        requestAnimationFrame(loop);
    }

    function spawnAsteroid() {
        const a = Math.random() * Math.PI * 2;
        const dist = ringRadius + 120;
        asteroids.push({
            x: w/2 + Math.cos(a) * dist,
            y: h/2 + Math.sin(a) * dist,
            r: 20 + Math.random() * 40,
            speed: 0.8 + Math.random() * 2.2,
            angle: a + Math.PI
        });
    }

    function spawnFuel() {
        if (Math.random() < 0.4) {
            const a = Math.random() * Math.PI * 2;
            fuels.push({
                x: w/2 + Math.cos(a) * (ringRadius * 0.78),
                y: h/2 + Math.sin(a) * (ringRadius * 0.78),
                r: 13
            });
        }
    }

    function explode(x, y, color = '#ff0066') {
        for (let i = 0; i < 60; i++) {
            const a = Math.random() * Math.PI * 2;
            const s = 4 + Math.random() * 11;
            particles.push({ x, y, vx: Math.cos(a)*s, vy: Math.sin(a)*s, life: 1, color });
        }
    }

    function loop() {
        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.fillRect(0, 0, w, h);

        // Сужение кольца — строго раз в 10 секунд
        const current10 = Math.floor(time / 10);
        if (current10 > lastShrink && ringRadius > 140) {
            lastShrink = current10;
            ringRadius *= 0.86;
        }

        if (Math.random() < 0.045 + time/600) spawnAsteroid();
        if (Math.random() < 0.03) spawnFuel();

        // След
        player.trail.push({x: player.x, y: player.y});
        if (player.trail.length > 22) player.trail.shift();
        ctx.strokeStyle = '#0ff'; ctx.lineWidth = 4;
        ctx.beginPath();
        player.trail.forEach((p,i) => i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y));
        ctx.stroke();

        // Корабль
        ctx.fillStyle = '#0ff';
        ctx.shadowBlur = 35; ctx.shadowColor = '#0ff';
        ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();

        // Астероиды
        for (let i = asteroids.length - 1; i >= 0; i--) {
            const a = asteroids[i];
            a.x += Math.cos(a.angle) * a.speed;
            a.y += Math.sin(a.angle) * a.speed;
            a.speed *= 1.014;

            ctx.fillStyle = '#aaa'; ctx.shadowColor = '#f55'; ctx.shadowBlur = 30;
            ctx.beginPath(); ctx.arc(a.x, a.y, a.r, 0, Math.PI*2); ctx.fill();

            if (Math.hypot(a.x - player.x, a.y - player.y) < a.r + player.r + 8) {
                explode(player.x, player.y);
                gameOver();
                return;
            }
        }

        // Топливо
        for (let i = fuels.length - 1; i >= 0; i--) {
            const f = fuels[i];
            ctx.fillStyle = '#00ffff'; ctx.shadowColor = '#0ff'; ctx.shadowBlur = 45;
            ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();

            if (Math.hypot(f.x - player.x, f.y - player.y) < f.r + player.r) {
                fuel = Math.min(100, fuel + 32);
                explode(f.x, f.y, '#00ffff');
                fuels.splice(i, 1);
            }
        }

        // Кольцо
        ctx.strokeStyle = `rgba(255,80,140,${0.5 + Math.sin(time*3)*0.25})`;
        ctx.lineWidth = 12;
        ctx.beginPath(); ctx.arc(w/2, h/2, ringRadius, 0, Math.PI*2); ctx.stroke();

        // Частицы
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.x += p.vx; p.y += p.vy; p.life -= 0.018;
            if (p.life <= 0) { particles.splice(i,1); continue; }
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x-4, p.y-4, 8, 8);
        }
        ctx.globalAlpha = 1;

        time += 1/60;
        fuel -= 0.011;
        document.getElementById('time').textContent = Math.floor(time);
        document.getElementById('fuel').textContent = Math.floor(fuel);

        if (fuel <= 0 || ringRadius < 140) gameOver();
        else requestAnimationFrame(loop);
    }

    function gameOver() {
        gameRunning = false;
        document.getElementById('finalTime').textContent = Math.floor(time);
        if (time > best) {
            best = Math.floor(time);
            localStorage.setItem('spaceEscapeBest', best);
            document.getElementById('best').textContent = best;
            document.getElementById('newRecord').style.display = 'block';
        } else {
            document.getElementById('newRecord').style.display = 'none';
        }
        explode(player.x, player.y, '#ff0066');
        setTimeout(() => document.getElementById('gameOverScreen').style.display = 'flex', 900);
    }
</script>
